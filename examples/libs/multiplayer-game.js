!function t(e,i,r){function n(o,a){if(!i[o]){if(!e[o]){var p="function"==typeof require&&require;if(!a&&p)return p(o,!0);if(s)return s(o,!0);var u=new Error("Cannot find module '"+o+"'");throw u.code="MODULE_NOT_FOUND",u}var d=i[o]={exports:{}};e[o][0].call(d.exports,function(t){var i=e[o][1][t];return n(i?i:t)},d,d.exports,t,e,i,r)}return i[o].exports}for(var s="function"==typeof require&&require,o=0;o<r.length;o++)n(r[o]);return n}({1:[function(t,e,i){function r(t,e){var i=this,r=new MilkCocoa(t);this.option=e||{},this.baseDS=r.dataStore(this.option.datastore||"mlkccagame"),this.pingManager=new a(this.baseDS),this.onCreatedObjectHandler=null,this.masters={},this.replicas={},this.baseDS.on("send",function(t){console.log(t),i.register(t.value)})}function n(){for(var t=(new Date).getTime().toString(36),e=0;6>e;e++)t+=String.fromCharCode(97+(260*Math.random()<<0)%26);return t}var s=t("./master"),o=t("./replica"),a=t("./pingman");r.prototype.register=function(t){var e=this;if(!this.masters.hasOwnProperty(t.id))if(e.replicas.hasOwnProperty(t.id))e.replicas[t.id]._update(t.value);else{var i=new o(e.baseDS,t.id,t.value);e.replicas[i.getId()]=i,e.pingManager.setRepl(i),i.onDestroyHandler(function(){delete e.replicas[i.getId()]}),e.onCreatedObjectHandler&&e.onCreatedObjectHandler(i)}},r.prototype.init=function(){var t=this;this.baseDS.stream().sort("desc").size(10).next(function(e,i){i.forEach(function(e){t.register(e),t.masters.hasOwnProperty(e.id)&&t.masters[e.id]._update(e.value)})})},r.prototype.createObject=function(t){var e=localStorage.getItem("mlkccagame.masterid");e||(e=n(),localStorage.setItem("mlkccagame.masterid",e)),this.replicas.hasOwnProperty(e)&&(t=this.replicas[e].getParams(),this.replicas[e].destroy(),delete this.replicas[e]),this.pingManager.setId(e);var i=new s(this.baseDS,e,t);return this.masters[i.getId()]=i,i},r.prototype.onCreatedObject=function(t){this.onCreatedObjectHandler=t},r.prototype.getNumOfRepls=function(){var t=0;for(var e in this.replicas)t++;return t},window.MultiPlayerGame=r},{"./master":2,"./pingman":3,"./replica":4}],2:[function(t,e,i){function r(t,e,i){this.id=e,this.params=i,this.onUpdateHandler=null,this.baseDS=t,console.log(this.baseDS),this.baseDS.set(this.id,this.params),this.saveTimer=null,this.updateCount=0}r.prototype.getId=function(){return this.id},r.prototype.getParams=function(){return this.params},r.prototype._update=function(t){for(var e in t)this.params[e]=t[e];this.onUpdateHandler&&this.onUpdateHandler(this.params)},r.prototype.update=function(t){var e=this;for(var i in t)this.params[i]=t[i];this.baseDS.send({id:this.id,value:t}),this.saveTimer&&clearTimeout(this.saveTimer),this.saveTimer=setTimeout(function(){e.save(),this.updateCount=0},5e3),this.updateCount++,this.updateCount>10&&(this.updateCount=0,e.save(),this.saveTimer&&clearTimeout(this.saveTimer))},r.prototype.save=function(){console.log("save"),this.baseDS.set(this.id,this.params)},r.prototype.onUpdate=function(t){this.onUpdateHandler=t},e.exports=r},{}],3:[function(t,e,i){function r(t,e){var i=this;this.id=null,this.option=e||{},this.option.ping_interval=this.option.ping_interval||12e3,this.handlers={},this.replIds={};var r=t.child("ping");r.on("send",function(t){i.replIds[t.value.id]&&i.replIds[t.value.id].recvPing()}),setInterval(function(){null!=i.id&&r.send({id:i.id})},this.option.ping_interval)}r.prototype.setId=function(t){this.id=t},r.prototype.setRepl=function(t){this.replIds[t.getId()]=t},e.exports=r},{}],4:[function(t,e,i){function r(t,e,i){var r=this;this.id=e,this.params=i,this.onUpdateHandler=null,this.onDestroyHandlers=[],this.alive=!0,this.timer=setTimeout(function(){r.alive=!1,r.fireOnDestroyHandlers()},26e3)}r.prototype.getId=function(){return this.id},r.prototype.getParams=function(){return this.params},r.prototype.isAlive=function(){return this.alive},r.prototype._update=function(t){this.onUpdateHandler&&this.onUpdateHandler(t)},r.prototype.onUpdate=function(t){this.onUpdateHandler=t},r.prototype.destroy=function(){this.alive=!1,this.fireOnDestroyHandlers()},r.prototype.onDestroyHandler=function(t){this.onDestroyHandlers.push(t)},r.prototype.fireOnDestroyHandlers=function(){this.onDestroyHandlers.forEach(function(t){t()})},r.prototype.recvPing=function(){var t=this;clearTimeout(this.timer),this.timer=setTimeout(function(){t.destroy()},26e3)},e.exports=r},{}]},{},[1]);