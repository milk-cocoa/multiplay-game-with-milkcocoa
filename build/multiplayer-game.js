!function t(e,i,n){function r(o,a){if(!i[o]){if(!e[o]){var p="function"==typeof require&&require;if(!a&&p)return p(o,!0);if(s)return s(o,!0);var u=new Error("Cannot find module '"+o+"'");throw u.code="MODULE_NOT_FOUND",u}var h=i[o]={exports:{}};e[o][0].call(h.exports,function(t){var i=e[o][1][t];return r(i?i:t)},h,h.exports,t,e,i,n)}return i[o].exports}for(var s="function"==typeof require&&require,o=0;o<n.length;o++)r(n[o]);return r}({1:[function(t,e,i){function n(t,e){var i=this,n=new MilkCocoa(t);this.option=e||{},this.baseDS=n.dataStore(this.option.datastore||"mlkccagame"),this.pingManager=new o(this.baseDS),this.onCreatedObjectHandler=null,this.masters={},this.replicas={},this.baseDS.on("send",function(t){i.register(t.value)})}var r=t("./master"),s=t("./replica"),o=t("./pingman");n.prototype.register=function(t){var e=this;if(!this.masters.hasOwnProperty(t.id))if(e.replicas.hasOwnProperty(t.id))e.replicas[t.id]._update(t.value);else{var i=new s(e.baseDS,t.id,t.value);e.replicas[i.getId()]=i,e.pingManager.setRepl(i),i.onDestroyHandler(function(){delete e.replicas[i.getId()]}),e.onCreatedObjectHandler&&e.onCreatedObjectHandler(i)}},n.prototype.init=function(){var t=this;this.baseDS.stream().sort("desc").size(10).next(function(e,i){i.forEach(function(e){t.register(e),t.masters.hasOwnProperty(e.id)&&t.masters[e.id]._update(e.value)})})},n.prototype.createObject=function(t,e){this.replicas.hasOwnProperty(t)&&(e=this.replicas[t].getParams(),this.replicas[t].destroy(),delete this.replicas[t]),this.pingManager.setId(t);var i=new r(this.baseDS,t,e);return this.masters[i.getId()]=i,i},n.prototype.onCreatedObject=function(t){this.onCreatedObjectHandler=t},n.prototype.getNumOfRepls=function(){var t=0;for(var e in this.replicas)t++;return t},window.MultiPlayerGame=n},{"./master":2,"./pingman":3,"./replica":4}],2:[function(t,e,i){function n(t,e,i){this.id=e,this.params=i,this.onUpdateHandler=null,this.baseDS=t,console.log(this.baseDS),this.baseDS.set(this.id,this.params),this.saveTimer=null,this.updateCount=0}n.prototype.getId=function(){return this.id},n.prototype.getParams=function(){return this.params},n.prototype._update=function(t){for(var e in t)this.params[e]=t[e];this.onUpdateHandler&&this.onUpdateHandler(this.params)},n.prototype.update=function(t){var e=this;for(var i in t)this.params[i]=t[i];this.baseDS.send({id:this.id,value:t}),this.saveTimer&&clearTimeout(this.saveTimer),this.saveTimer=setTimeout(function(){e.save(),this.updateCount=0},5e3),this.updateCount++,this.updateCount>12&&(this.updateCount=0,e.save(),this.saveTimer&&clearTimeout(this.saveTimer))},n.prototype.save=function(){console.log("save"),this.baseDS.set(this.id,this.params)},n.prototype.onUpdate=function(t){this.onUpdateHandler=t},e.exports=n},{}],3:[function(t,e,i){function n(t,e){var i=this;this.id=null,this.option=e||{},this.option.ping_interval=this.option.ping_interval||12e3,this.handlers={},this.replIds={};var n=t.child("ping");n.on("send",function(t){i.replIds[t.value.id]&&i.replIds[t.value.id].recvPing()}),setInterval(function(){null!=i.id&&n.send({id:i.id})},this.option.ping_interval)}n.prototype.setId=function(t){this.id=t},n.prototype.setRepl=function(t){this.replIds[t.getId()]=t},e.exports=n},{}],4:[function(t,e,i){function n(t,e,i){var n=this;this.id=e,this.params=i,this.onUpdateHandler=null,this.onDestroyHandlers=[],this.alive=!0,this.timer=setTimeout(function(){n.alive=!1,n.fireOnDestroyHandlers()},26e3)}n.prototype.getId=function(){return this.id},n.prototype.getParams=function(){return this.params},n.prototype.isAlive=function(){return this.alive},n.prototype._update=function(t){this.onUpdateHandler&&this.onUpdateHandler(t)},n.prototype.onUpdate=function(t){this.onUpdateHandler=t},n.prototype.destroy=function(){this.alive=!1,this.fireOnDestroyHandlers()},n.prototype.onDestroyHandler=function(t){this.onDestroyHandlers.push(t)},n.prototype.fireOnDestroyHandlers=function(){this.onDestroyHandlers.forEach(function(t){t()})},n.prototype.recvPing=function(){var t=this;clearTimeout(this.timer),this.timer=setTimeout(function(){t.destroy()},26e3)},e.exports=n},{}]},{},[1]);